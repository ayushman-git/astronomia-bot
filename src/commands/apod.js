const { EmbedBuilder } = require("discord.js");
require("dotenv").config();
const axios = require("axios");
const commandUsage = require("../support/commandUsage");

let apodData = null;
function fetchData() {
  axios
    .get(
      "https://api.nasa.gov/planetary/apod?api_key=" + process.env.NASA_APID_KEY
    )
    .then((res) => {
      if (res.status >= 400) {
        return;
      }
      apodData = res.data;

      console.log("APOD Image fetched (Command)", Date());
    })
    .catch((err) => {
      console.log(err);
    });
}

const showEmbed = () => {
  if(apodData.media_type === "video") {
    return apodData.url;
  }
  const apodEmbed = new EmbedBuilder()
    .setColor("#F0386B")
    .setTitle(apodData.title)
    .setDescription(`\`\`\` ${apodData.explanation}\`\`\``)
    .setURL(apodData.url)
    .setImage(apodData.url)
    .setTimestamp(apodData.date)
    .setFooter({
      text: "Generated by astronomia with NASA's APOD API",
      iconURL: "https://firebasestorage.googleapis.com/v0/b/astronomia-c2f5d.appspot.com/o/nasa-seeklogo%201.png?alt=media&token=a4288e39-1f8a-4639-af85-c5f9ff13f877"
    });
  return apodEmbed;
};
fetchData();
setInterval(() => {
  fetchData();
}, 3600000);
const name = "apod";
module.exports = {
  name,
  aliases: ["a"],
  description: "Astronomy Picture of Day",
  execute(message, args, client, db) {
    (async () => {
      commandUsage(name, db);
      const embedOrUrl = showEmbed();
      if (typeof embedOrUrl === 'string') {
        message.channel.send(embedOrUrl);
      } else {
        message.channel.send({ embeds: [embedOrUrl] });
      }
    })();
  },
};
